name: Deploy to Staging

on:
  push:
    branches:
      - develop
  workflow_dispatch:
    inputs:
      skip_migrations:
        description: 'Skip database migrations'
        type: boolean
        default: false

concurrency:
  group: deploy-staging
  cancel-in-progress: false

jobs:
  # Run tests before deployment
  test-build:
    name: Test and Build
    uses: ./.github/workflows/test-build.yml
    secrets: inherit

  # Run database migrations
  migrations:
    name: Run Staging Migrations
    needs: test-build
    if: ${{ github.event.inputs.skip_migrations != 'true' }}
    runs-on: blacksmith-4vcpu-ubuntu-2404

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.3

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
            **/node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Apply migrations to staging database
        working-directory: ./packages/db
        env:
          DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
        run: bunx drizzle-kit migrate --config=./drizzle.config.ts

  # Build and push Docker images
  build-images:
    name: Build Docker Images
    needs: test-build
    runs-on: blacksmith-8vcpu-ubuntu-2404
    permissions:
      contents: read
      packages: write
    outputs:
      image_tag: ${{ steps.meta.outputs.tag }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - dockerfile: ./docker/app.Dockerfile
            image: ghcr.io/simstudioai/simstudio
          - dockerfile: ./docker/db.Dockerfile
            image: ghcr.io/simstudioai/migrations
          - dockerfile: ./docker/realtime.Dockerfile
            image: ghcr.io/simstudioai/realtime

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: useblacksmith/setup-docker-builder@v1

      - name: Generate image tags
        id: meta
        env:
          IMAGE: ${{ matrix.image }}
          SHA: ${{ github.sha }}
        run: |
          SHORT_SHA="${SHA:0:7}"
          echo "tag=staging-${SHORT_SHA}" >> "$GITHUB_OUTPUT"
          echo "tags=${IMAGE}:staging,${IMAGE}:staging-${SHORT_SHA}" >> "$GITHUB_OUTPUT"

      - name: Build and push images
        uses: useblacksmith/build-push-action@v2
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          provenance: false
          sbom: false

  # Deploy to Kubernetes
  deploy:
    name: Deploy to Staging Cluster
    needs: [migrations, build-images]
    if: always() && needs.build-images.result == 'success' && (needs.migrations.result == 'success' || needs.migrations.result == 'skipped')
    uses: ./.github/workflows/deploy-helm-template.yml
    with:
      environment: staging
      namespace: paperless-staging
      image_tag: staging
    secrets:
      KUBE_CONFIG_DATA: ${{ secrets.STAGING_KUBE_CONFIG_DATA }}
      DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
      BETTER_AUTH_SECRET: ${{ secrets.STAGING_BETTER_AUTH_SECRET }}
      ENCRYPTION_KEY: ${{ secrets.STAGING_ENCRYPTION_KEY }}
      INTERNAL_API_SECRET: ${{ secrets.STAGING_INTERNAL_API_SECRET }}
      CRON_SECRET: ${{ secrets.STAGING_CRON_SECRET }}

  # Post-deployment verification
  verify:
    name: Verify Staging Deployment
    needs: deploy
    runs-on: blacksmith-4vcpu-ubuntu-2404

    steps:
      - name: Configure kubeconfig
        env:
          KUBE_CONFIG_DATA: ${{ secrets.STAGING_KUBE_CONFIG_DATA }}
        run: |
          mkdir -p "$HOME/.kube"
          echo "$KUBE_CONFIG_DATA" | base64 -d > "$HOME/.kube/config"
          chmod 600 "$HOME/.kube/config"

      - name: Health check
        run: |
          echo "Checking deployment health..."

          # Check pod status
          READY_PODS=$(kubectl get pods -n paperless-staging -o jsonpath='{.items[*].status.conditions[?(@.type=="Ready")].status}' | tr ' ' '\n' | grep -c "True" || echo "0")
          TOTAL_PODS=$(kubectl get pods -n paperless-staging --no-headers | wc -l)

          echo "Ready pods: $READY_PODS / $TOTAL_PODS"

          if [ "$READY_PODS" -lt 1 ]; then
            echo "No ready pods found!"
            kubectl get pods -n paperless-staging
            kubectl describe pods -n paperless-staging
            exit 1
          fi

          echo "Staging deployment verified successfully!"

      - name: Create deployment summary
        env:
          COMMIT_SHA: ${{ github.sha }}
        run: |
          {
            echo "## Staging Deployment Complete"
            echo ""
            echo "**Commit:** $COMMIT_SHA"
            echo "**Namespace:** paperless-staging"
            echo "**Status:** Healthy"
          } >> "$GITHUB_STEP_SUMMARY"
