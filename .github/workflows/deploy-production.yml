name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      skip_migrations:
        description: 'Skip database migrations'
        type: boolean
        default: false
      image_tag:
        description: 'Specific image tag to deploy (defaults to latest)'
        type: string
        default: 'latest'

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  # Run tests before deployment
  test-build:
    name: Test and Build
    uses: ./.github/workflows/test-build.yml
    secrets: inherit

  # Detect version from commit message
  detect-version:
    name: Detect Version
    runs-on: blacksmith-4vcpu-ubuntu-2404
    outputs:
      version: ${{ steps.extract.outputs.version }}
      is_release: ${{ steps.extract.outputs.is_release }}
    steps:
      - name: Extract version from commit message
        id: extract
        env:
          COMMIT_MSG: ${{ github.event.head_commit.message }}
        run: |
          # Only tag versions on main branch - use env var to avoid injection
          if [[ "$COMMIT_MSG" =~ ^(v[0-9]+\.[0-9]+\.[0-9]+): ]]; then
            VERSION="${BASH_REMATCH[1]}"
            echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
            echo "is_release=true" >> "$GITHUB_OUTPUT"
            echo "Detected release commit: ${VERSION}"
          else
            echo "version=" >> "$GITHUB_OUTPUT"
            echo "is_release=false" >> "$GITHUB_OUTPUT"
            echo "Not a release commit"
          fi

  # Run database migrations
  migrations:
    name: Run Production Migrations
    needs: test-build
    if: ${{ github.event.inputs.skip_migrations != 'true' }}
    runs-on: blacksmith-4vcpu-ubuntu-2404

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.3

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
            **/node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Apply migrations to production database
        working-directory: ./packages/db
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: bunx drizzle-kit migrate --config=./drizzle.config.ts

  # Build and push Docker images
  build-images:
    name: Build Docker Images
    needs: [test-build, detect-version]
    runs-on: blacksmith-8vcpu-ubuntu-2404
    permissions:
      contents: read
      packages: write
    outputs:
      image_tag: ${{ steps.meta.outputs.tag }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - dockerfile: ./docker/app.Dockerfile
            image: ghcr.io/simstudioai/simstudio
          - dockerfile: ./docker/db.Dockerfile
            image: ghcr.io/simstudioai/migrations
          - dockerfile: ./docker/realtime.Dockerfile
            image: ghcr.io/simstudioai/realtime

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: useblacksmith/setup-docker-builder@v1

      - name: Generate image tags
        id: meta
        env:
          IMAGE: ${{ matrix.image }}
          SHA: ${{ github.sha }}
          IS_RELEASE: ${{ needs.detect-version.outputs.is_release }}
          VERSION: ${{ needs.detect-version.outputs.version }}
        run: |
          SHORT_SHA="${SHA:0:7}"
          TAGS="${IMAGE}:latest,${IMAGE}:${SHORT_SHA}"

          if [ "$IS_RELEASE" = "true" ] && [ -n "$VERSION" ]; then
            TAGS="${TAGS},${IMAGE}:${VERSION}"
            echo "Adding version tag: ${VERSION}"
          fi

          echo "tag=latest" >> "$GITHUB_OUTPUT"
          echo "tags=${TAGS}" >> "$GITHUB_OUTPUT"

      - name: Build and push images
        uses: useblacksmith/build-push-action@v2
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          provenance: false
          sbom: false

  # Deploy to Kubernetes
  deploy:
    name: Deploy to Production Cluster
    needs: [migrations, build-images]
    if: always() && needs.build-images.result == 'success' && (needs.migrations.result == 'success' || needs.migrations.result == 'skipped')
    uses: ./.github/workflows/deploy-helm-template.yml
    with:
      environment: production
      namespace: paperless-production
      image_tag: ${{ github.event.inputs.image_tag || 'latest' }}
    secrets:
      KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      BETTER_AUTH_SECRET: ${{ secrets.BETTER_AUTH_SECRET }}
      ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
      INTERNAL_API_SECRET: ${{ secrets.INTERNAL_API_SECRET }}
      CRON_SECRET: ${{ secrets.CRON_SECRET }}

  # Post-deployment verification
  verify:
    name: Verify Production Deployment
    needs: deploy
    runs-on: blacksmith-4vcpu-ubuntu-2404

    steps:
      - name: Configure kubeconfig
        env:
          KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
        run: |
          mkdir -p "$HOME/.kube"
          echo "$KUBE_CONFIG_DATA" | base64 -d > "$HOME/.kube/config"
          chmod 600 "$HOME/.kube/config"

      - name: Health check
        run: |
          echo "Checking production deployment health..."

          # Check pod status
          READY_PODS=$(kubectl get pods -n paperless-production -o jsonpath='{.items[*].status.conditions[?(@.type=="Ready")].status}' | tr ' ' '\n' | grep -c "True" || echo "0")
          TOTAL_PODS=$(kubectl get pods -n paperless-production --no-headers | wc -l)

          echo "Ready pods: $READY_PODS / $TOTAL_PODS"

          if [ "$READY_PODS" -lt 1 ]; then
            echo "No ready pods found!"
            kubectl get pods -n paperless-production
            kubectl describe pods -n paperless-production
            exit 1
          fi

          echo "Production deployment verified successfully!"

      - name: Create deployment summary
        env:
          COMMIT_SHA: ${{ github.sha }}
        run: |
          {
            echo "## Production Deployment Complete"
            echo ""
            echo "**Commit:** $COMMIT_SHA"
            echo "**Namespace:** paperless-production"
            echo "**Status:** Healthy"
          } >> "$GITHUB_STEP_SUMMARY"

  # Notify on failure
  notify-failure:
    name: Notify on Failure
    needs: [deploy, verify]
    if: failure()
    runs-on: blacksmith-2vcpu-ubuntu-2404
    steps:
      - name: Create failure summary
        env:
          COMMIT_SHA: ${{ github.sha }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          {
            echo "## Production Deployment Failed"
            echo ""
            echo "**Commit:** $COMMIT_SHA"
            echo "**Details:** [View workflow run]($RUN_URL)"
            echo ""
            echo "Please investigate the failure and retry if necessary."
          } >> "$GITHUB_STEP_SUMMARY"
