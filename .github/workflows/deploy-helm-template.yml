name: Deploy Helm Template

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
        description: 'Deployment environment (staging or production)'
      namespace:
        required: true
        type: string
        description: 'Kubernetes namespace'
      image_tag:
        required: false
        type: string
        default: 'latest'
        description: 'Docker image tag to deploy'
    secrets:
      KUBE_CONFIG_DATA:
        required: true
        description: 'Base64 encoded kubeconfig'
      DATABASE_URL:
        required: true
        description: 'Database connection URL'
      BETTER_AUTH_SECRET:
        required: true
        description: 'Authentication secret'
      ENCRYPTION_KEY:
        required: true
        description: 'Encryption key'
      INTERNAL_API_SECRET:
        required: true
        description: 'Internal API secret'
      CRON_SECRET:
        required: false
        description: 'Cron job authentication secret'

jobs:
  deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: blacksmith-4vcpu-ubuntu-2404
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.29.0'

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.14.0'

      - name: Configure kubeconfig
        env:
          KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
        run: |
          mkdir -p "$HOME/.kube"
          echo "$KUBE_CONFIG_DATA" | base64 -d > "$HOME/.kube/config"
          chmod 600 "$HOME/.kube/config"

      - name: Verify cluster connection
        run: |
          kubectl cluster-info
          kubectl get namespaces

      - name: Create namespace if not exists
        env:
          NAMESPACE: ${{ inputs.namespace }}
        run: |
          kubectl create namespace "$NAMESPACE" --dry-run=client -o yaml | kubectl apply -f -

      - name: Extract database connection details
        id: db
        env:
          DB_URL: ${{ secrets.DATABASE_URL }}
        run: |
          # Parse DATABASE_URL to extract components
          # Format: postgresql://user:password@host:port/database?sslmode=require

          # Extract host (between @ and :port)
          DB_HOST=$(echo "$DB_URL" | sed -n 's/.*@\([^:]*\):.*/\1/p')
          # Extract port (between host: and /database)
          DB_PORT=$(echo "$DB_URL" | sed -n 's/.*:\([0-9]*\)\/.*/\1/p')
          # Extract database name (between port/ and ?)
          DB_NAME=$(echo "$DB_URL" | sed -n 's/.*\/\([^?]*\).*/\1/p')
          # Extract username (between :// and :password)
          DB_USER=$(echo "$DB_URL" | sed -n 's/.*:\/\/\([^:]*\):.*/\1/p')
          # Extract password (between user: and @)
          DB_PASS=$(echo "$DB_URL" | sed -n 's/.*:\/\/[^:]*:\([^@]*\)@.*/\1/p')

          echo "host=${DB_HOST}" >> "$GITHUB_OUTPUT"
          echo "port=${DB_PORT}" >> "$GITHUB_OUTPUT"
          echo "database=${DB_NAME}" >> "$GITHUB_OUTPUT"
          echo "username=${DB_USER}" >> "$GITHUB_OUTPUT"
          echo "::add-mask::${DB_PASS}"
          echo "password=${DB_PASS}" >> "$GITHUB_OUTPUT"

      - name: Deploy with Helm
        env:
          NAMESPACE: ${{ inputs.namespace }}
          IMAGE_TAG: ${{ inputs.image_tag }}
          DB_HOST: ${{ steps.db.outputs.host }}
          DB_PORT: ${{ steps.db.outputs.port }}
          DB_USER: ${{ steps.db.outputs.username }}
          DB_PASS: ${{ steps.db.outputs.password }}
          DB_NAME: ${{ steps.db.outputs.database }}
          BETTER_AUTH_SECRET: ${{ secrets.BETTER_AUTH_SECRET }}
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
          INTERNAL_API_SECRET: ${{ secrets.INTERNAL_API_SECRET }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          helm upgrade --install paperless ./helm/sim \
            --namespace "$NAMESPACE" \
            --create-namespace \
            --wait \
            --timeout 10m \
            --set global.imageRegistry=ghcr.io \
            --set app.image.repository=simstudioai/simstudio \
            --set app.image.tag="$IMAGE_TAG" \
            --set realtime.image.repository=simstudioai/realtime \
            --set realtime.image.tag="$IMAGE_TAG" \
            --set migrations.image.repository=simstudioai/migrations \
            --set migrations.image.tag="$IMAGE_TAG" \
            --set postgresql.enabled=false \
            --set externalDatabase.enabled=true \
            --set externalDatabase.host="$DB_HOST" \
            --set externalDatabase.port="$DB_PORT" \
            --set externalDatabase.username="$DB_USER" \
            --set externalDatabase.password="$DB_PASS" \
            --set externalDatabase.database="$DB_NAME" \
            --set externalDatabase.sslMode=require \
            --set app.env.BETTER_AUTH_SECRET="$BETTER_AUTH_SECRET" \
            --set app.env.ENCRYPTION_KEY="$ENCRYPTION_KEY" \
            --set app.env.INTERNAL_API_SECRET="$INTERNAL_API_SECRET" \
            --set app.env.CRON_SECRET="$CRON_SECRET" \
            --set app.env.NODE_ENV=production \
            --set realtime.env.BETTER_AUTH_SECRET="$BETTER_AUTH_SECRET"

      - name: Wait for deployment to stabilize
        env:
          NAMESPACE: ${{ inputs.namespace }}
        run: |
          echo "Waiting for deployments to stabilize..."
          kubectl rollout status deployment/paperless-app -n "$NAMESPACE" --timeout=300s || true
          kubectl rollout status deployment/paperless-realtime -n "$NAMESPACE" --timeout=300s || true

      - name: Verify deployment
        env:
          NAMESPACE: ${{ inputs.namespace }}
        run: |
          echo "=== Deployment Status ==="
          kubectl get deployments -n "$NAMESPACE"
          echo ""
          echo "=== Pod Status ==="
          kubectl get pods -n "$NAMESPACE"
          echo ""
          echo "=== Services ==="
          kubectl get services -n "$NAMESPACE"

      - name: Generate deployment summary
        env:
          ENVIRONMENT: ${{ inputs.environment }}
          NAMESPACE: ${{ inputs.namespace }}
          IMAGE_TAG: ${{ inputs.image_tag }}
          COMMIT_SHA: ${{ github.sha }}
        run: |
          {
            echo "## Deployment Summary"
            echo ""
            echo "| Property | Value |"
            echo "|----------|-------|"
            echo "| Environment | $ENVIRONMENT |"
            echo "| Namespace | $NAMESPACE |"
            echo "| Image Tag | $IMAGE_TAG |"
            echo "| Commit | $COMMIT_SHA |"
            echo ""
            echo "### Deployed Pods"
            echo '```'
            kubectl get pods -n "$NAMESPACE" -o wide
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"
